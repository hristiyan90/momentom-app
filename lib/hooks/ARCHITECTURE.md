# useSession Hook - Architecture Diagram

Visual guide to understanding the session management system.

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     React Component                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  const { session, loading, error, isRefreshing } =    â”‚  â”‚
â”‚  â”‚         useSession()                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   useSession Hook                            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   State      â”‚  â”‚   Timers     â”‚  â”‚   Refresh    â”‚     â”‚
â”‚  â”‚  Management  â”‚  â”‚   (30s poll) â”‚  â”‚   Logic      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Supabase Client SDK                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  auth.getSession()â”‚         â”‚ auth.refreshSession()â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Browser Cookies                            â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  sb-access-token (httpOnly)                          â”‚  â”‚
â”‚  â”‚  sb-refresh-token (httpOnly)                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Session Lifecycle

```
1. Component Mount
   â”‚
   â”œâ”€â–º fetchSession()
   â”‚   â”‚
   â”‚   â”œâ”€â–º supabaseClient.auth.getSession()
   â”‚   â”‚   â”‚
   â”‚   â”‚   â””â”€â–º Reads cookies â†’ Returns Session object
   â”‚   â”‚
   â”‚   â””â”€â–º setSession(session)
   â”‚       setLoading(false)
   â”‚
   â”œâ”€â–º Start expiration timer (30s interval)
   â”‚
   â””â”€â–º Component renders with session data

2. During Session (Normal Use)
   â”‚
   â”œâ”€â–º Every 30 seconds: Check time until expiry
   â”‚   â”‚
   â”‚   â”œâ”€â–º If > 5 minutes: Do nothing
   â”‚   â”‚
   â”‚   â””â”€â–º If < 5 minutes: Trigger refresh
   â”‚       â”‚
   â”‚       â””â”€â–º Go to step 3
   â”‚
   â””â”€â–º User continues using app

3. Refresh Triggered
   â”‚
   â”œâ”€â–º Set isRefreshing = true (UI shows indicator)
   â”‚
   â”œâ”€â–º Call refreshSession()
   â”‚   â”‚
   â”‚   â”œâ”€â–º Attempt 1 (0s delay)
   â”‚   â”‚   â”‚
   â”‚   â”‚   â”œâ”€â–º Success â†’ Update session â†’ Done âœ…
   â”‚   â”‚   â”‚
   â”‚   â”‚   â””â”€â–º Failure â†’ Wait 1s â†’ Attempt 2
   â”‚   â”‚       â”‚
   â”‚   â”‚       â”œâ”€â–º Success â†’ Update session â†’ Done âœ…
   â”‚   â”‚       â”‚
   â”‚   â”‚       â””â”€â–º Failure â†’ Wait 2s â†’ Attempt 3
   â”‚   â”‚           â”‚
   â”‚   â”‚           â”œâ”€â–º Success â†’ Update session â†’ Done âœ…
   â”‚   â”‚           â”‚
   â”‚   â”‚           â””â”€â–º Failure â†’ router.push('/login') ğŸ”´
   â”‚   â”‚
   â”‚   â””â”€â–º Set isRefreshing = false
   â”‚
   â””â”€â–º Continue monitoring (back to step 2)

4. Session Expired / Refresh Failed
   â”‚
   â””â”€â–º router.push('/login')
       â”‚
       â””â”€â–º User must log in again
```

## Auto-Refresh Timeline

```
Hour-long token lifecycle:

0s                                                              3600s
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  Normal Use (55 minutes)            Warning (5 minutes)        â”‚
â”‚  - No API calls                     - Check every 30s          â”‚
â”‚  - Token valid                      - Refresh triggered        â”‚
â”‚                                     - Retry if needed          â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3300s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²
                              â”‚
                        Refresh trigger point
                        (5 minutes before expiry)


Detailed warning period:

3300s    3305s    3310s    3330s    3360s    3390s    3600s
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚
â”‚ Check  â”‚        â”‚        â”‚ Check  â”‚ Check  â”‚ Check  â”‚ Expired
â”‚ Detect â”‚        â”‚        â”‚        â”‚        â”‚        â”‚
â”‚ < 5min â”‚        â”‚        â”‚        â”‚        â”‚        â”‚
â”‚        â”‚        â”‚        â”‚        â”‚        â”‚        â”‚
â””â–º Trigger refresh                                     â”‚
   â”‚                                                   â”‚
   â”œâ”€â–º Attempt 1 (0s)                                 â”‚
   â”œâ”€â–º Attempt 2 (+1s if needed)                      â”‚
   â”œâ”€â–º Attempt 3 (+3s if needed)                      â”‚
   â”‚                                                   â”‚
   â””â”€â–º Success: New token valid until ~7200s          â”‚
       Failure: Redirect to /login                    â”‚
```

## Retry Logic Flow

```
refreshSession() called
     â”‚
     â”œâ”€â–º Check if refresh already in progress
     â”‚   â”‚
     â”‚   â”œâ”€â–º Yes: Return false (skip)
     â”‚   â””â”€â–º No: Set refreshInProgress = true
     â”‚
     â”œâ”€â–º Check if refresh_token exists
     â”‚   â”‚
     â”‚   â”œâ”€â–º No: Redirect to /login immediately
     â”‚   â””â”€â–º Yes: Continue
     â”‚
     â”œâ”€â–º Attempt 1 (0 seconds delay)
     â”‚   â”‚
     â”‚   â”œâ”€â–º supabaseClient.auth.refreshSession()
     â”‚   â”‚
     â”‚   â”œâ”€â–º Success?
     â”‚   â”‚   â”œâ”€â–º Yes: setSession(newSession)
     â”‚   â”‚   â”‚        return true âœ…
     â”‚   â”‚   â”‚
     â”‚   â”‚   â””â”€â–º No: Continue to Attempt 2
     â”‚
     â”œâ”€â–º Wait 1 second
     â”‚
     â”œâ”€â–º Attempt 2 (1 second delay)
     â”‚   â”‚
     â”‚   â”œâ”€â–º supabaseClient.auth.refreshSession()
     â”‚   â”‚
     â”‚   â”œâ”€â–º Success?
     â”‚   â”‚   â”œâ”€â–º Yes: setSession(newSession)
     â”‚   â”‚   â”‚        return true âœ…
     â”‚   â”‚   â”‚
     â”‚   â”‚   â””â”€â–º No: Continue to Attempt 3
     â”‚
     â”œâ”€â–º Wait 2 seconds
     â”‚
     â”œâ”€â–º Attempt 3 (3 seconds total delay)
     â”‚   â”‚
     â”‚   â”œâ”€â–º supabaseClient.auth.refreshSession()
     â”‚   â”‚
     â”‚   â”œâ”€â–º Success?
     â”‚   â”‚   â”œâ”€â–º Yes: setSession(newSession)
     â”‚   â”‚   â”‚        return true âœ…
     â”‚   â”‚   â”‚
     â”‚   â”‚   â””â”€â–º No: All attempts failed
     â”‚
     â””â”€â–º All attempts failed (7 seconds total)
         â”‚
         â””â”€â–º router.push('/login') ğŸ”´
             return false
```

## State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    useSession State                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  session: Session | null                                â”‚
â”‚  â”œâ”€â–º null: No active session (logged out)              â”‚
â”‚  â””â”€â–º Session: Active session with user data            â”‚
â”‚      â”œâ”€â–º access_token: JWT for API requests            â”‚
â”‚      â”œâ”€â–º refresh_token: Token to get new access_token  â”‚
â”‚      â”œâ”€â–º expires_at: Unix timestamp of expiration      â”‚
â”‚      â””â”€â–º user: User object (id, email, etc.)           â”‚
â”‚                                                          â”‚
â”‚  loading: boolean                                       â”‚
â”‚  â”œâ”€â–º true: Initial session fetch in progress           â”‚
â”‚  â””â”€â–º false: Session loaded (or confirmed no session)   â”‚
â”‚                                                          â”‚
â”‚  error: string | null                                   â”‚
â”‚  â”œâ”€â–º null: No errors                                   â”‚
â”‚  â””â”€â–º string: Error message (fetch failed, etc.)        â”‚
â”‚                                                          â”‚
â”‚  isRefreshing: boolean                                  â”‚
â”‚  â”œâ”€â–º true: Token refresh in progress (show UI)         â”‚
â”‚  â””â”€â–º false: No refresh happening                       â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Internal Refs                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  refreshInProgress: useRef<boolean>                     â”‚
â”‚  â”œâ”€â–º true: Refresh logic executing (prevent concurrent) â”‚
â”‚  â””â”€â–º false: No refresh in progress                     â”‚
â”‚                                                          â”‚
â”‚  Note: This is separate from isRefreshing state         â”‚
â”‚        - ref: Internal flag (no re-render)              â”‚
â”‚        - state: External UI feedback (triggers render)  â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Integration with Backend

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend (Browser)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  useSession Hook                        â”‚            â”‚
â”‚  â”‚  - Manages session state                â”‚            â”‚
â”‚  â”‚  - Auto-refreshes token                 â”‚            â”‚
â”‚  â”‚  - Handles retry logic                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â”‚                                   â”‚
â”‚                      â”‚ Uses                              â”‚
â”‚                      â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Supabase Client SDK                    â”‚            â”‚
â”‚  â”‚  - auth.getSession()                    â”‚            â”‚
â”‚  â”‚  - auth.refreshSession()                â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ HTTP Requests
                       â”‚ (includes cookies)
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend (Server)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  API Routes (e.g., /api/data)          â”‚            â”‚
â”‚  â”‚  - Validates access_token               â”‚            â”‚
â”‚  â”‚  - Uses getAthleteId()                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â”‚                                   â”‚
â”‚                      â”‚ Uses                              â”‚
â”‚                      â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  lib/auth/session.ts                    â”‚            â”‚
â”‚  â”‚  - getSession(): Extract from request   â”‚            â”‚
â”‚  â”‚  - refreshSession(): Server-side refreshâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                      â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Supabase API calls
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Supabase (Auth Service)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  - Validates tokens                                      â”‚
â”‚  - Issues new tokens                                     â”‚
â”‚  - Manages sessions                                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Flow Example:

1. User loads page â†’ useSession() â†’ getSession() â†’ Display UI
2. Token about to expire â†’ useSession() â†’ refreshSession() â†’ New token
3. User clicks button â†’ API call â†’ Backend validates â†’ Returns data
4. Token expired â†’ API returns 401 â†’ useSession redirects â†’ /login
```

## Error Handling Flow

```
Error occurs during refresh
     â”‚
     â”œâ”€â–º Error Type: No refresh token
     â”‚   â””â”€â–º Action: Immediate redirect to /login
     â”‚
     â”œâ”€â–º Error Type: Network error
     â”‚   â””â”€â–º Action: Retry with backoff
     â”‚       â”‚
     â”‚       â”œâ”€â–º Attempt 1 fails â†’ Wait 1s
     â”‚       â”œâ”€â–º Attempt 2 fails â†’ Wait 2s
     â”‚       â”œâ”€â–º Attempt 3 fails â†’ Wait 4s
     â”‚       â””â”€â–º All failed â†’ Redirect to /login
     â”‚
     â”œâ”€â–º Error Type: Invalid token (auth error)
     â”‚   â””â”€â–º Action: Retry with backoff
     â”‚       â””â”€â–º Same as network error
     â”‚
     â””â”€â–º Error Type: Token already expired
         â””â”€â–º Action: Immediate redirect to /login


Error State Management:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error occurs                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Log error to console                    â”‚
â”‚  console.error('Refresh failed:', err)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check if last attempt                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  If Yes:                                 â”‚
â”‚    â””â”€> router.push('/login')            â”‚
â”‚                                          â”‚
â”‚  If No:                                  â”‚
â”‚    â””â”€> Wait and retry                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Performance Characteristics

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Resource Usage per Hour                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Normal Period (55 minutes):                            â”‚
â”‚  â”œâ”€â–º API Calls: 0                                       â”‚
â”‚  â”œâ”€â–º Memory: ~5KB (session object)                     â”‚
â”‚  â””â”€â–º CPU: ~0% (setTimeout inactive)                    â”‚
â”‚                                                          â”‚
â”‚  Warning Period (5 minutes):                            â”‚
â”‚  â”œâ”€â–º API Calls: 0 (polling uses setTimeout)            â”‚
â”‚  â”œâ”€â–º Memory: ~5KB (same session object)                â”‚
â”‚  â””â”€â–º CPU: ~0.01% (30s interval checks)                 â”‚
â”‚                                                          â”‚
â”‚  Refresh Operation (1-7 seconds):                       â”‚
â”‚  â”œâ”€â–º API Calls: 1-3 (depending on retries)             â”‚
â”‚  â”œâ”€â–º Memory: ~5KB (session object updated)             â”‚
â”‚  â””â”€â–º CPU: ~1% (during API call)                        â”‚
â”‚                                                          â”‚
â”‚  Total per Hour:                                        â”‚
â”‚  â”œâ”€â–º API Calls: 2-4 (initial + refresh)                â”‚
â”‚  â”œâ”€â–º Memory: ~5KB steady state                         â”‚
â”‚  â””â”€â–º CPU: < 0.1% average                               â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layers                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  Layer 1: Token Storage                                 â”‚
â”‚  â”œâ”€â–º Access token: Memory only (cleared on close)      â”‚
â”‚  â”œâ”€â–º Refresh token: HttpOnly cookie (JS cannot access) â”‚
â”‚  â””â”€â–º XSS Protection: No tokens in localStorage         â”‚
â”‚                                                          â”‚
â”‚  Layer 2: Transport Security                            â”‚
â”‚  â”œâ”€â–º HTTPS only: All requests encrypted                â”‚
â”‚  â”œâ”€â–º Secure cookies: Secure flag set                   â”‚
â”‚  â””â”€â–º SameSite: CSRF protection                         â”‚
â”‚                                                          â”‚
â”‚  Layer 3: Token Validation                              â”‚
â”‚  â”œâ”€â–º Backend validates every request                   â”‚
â”‚  â”œâ”€â–º Short-lived access tokens (1 hour)                â”‚
â”‚  â””â”€â–º Refresh tokens rotated on use                     â”‚
â”‚                                                          â”‚
â”‚  Layer 4: Error Handling                                â”‚
â”‚  â”œâ”€â–º Failed refresh â†’ Redirect to login                â”‚
â”‚  â”œâ”€â–º No grace period for expired tokens                â”‚
â”‚  â””â”€â–º Clean session state on error                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Quick Reference

### Key Timing Values
- **Token lifetime**: 3600 seconds (1 hour)
- **Warning threshold**: 300 seconds (5 minutes)
- **Poll interval**: 30 seconds
- **Max retries**: 3 attempts
- **Retry delays**: 1s, 2s, 4s (exponential backoff)

### Key Functions
- `useSession()`: Main hook
- `fetchSession()`: Get current session
- `refreshSession()`: Refresh with retry logic

### Key States
- `session`: Current session data
- `loading`: Initial load in progress
- `error`: Error message
- `isRefreshing`: Refresh in progress

### Key Events
- Component mount â†’ Fetch session
- < 5 min to expiry â†’ Start polling
- Poll detects expiry soon â†’ Trigger refresh
- Refresh succeeds â†’ Update session
- Refresh fails 3x â†’ Redirect to login

---

For implementation details, see:
- `/lib/hooks/useSession.ts` - Source code
- `/lib/hooks/README.md` - Full documentation
- `/lib/hooks/QUICKSTART.md` - Getting started guide
